<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DuoKid</title>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: radial-gradient(circle at center, #001533, #000a1a);
        color: white;
        text-align: center;
    }

    .container {
        margin: 40px auto;
        max-width: 450px;
        padding: 20px;
        background: white;
        color: black;
        border-radius: 20px;
        box-shadow: 0 0 40px rgba(120, 80, 255, 0.6);
    }

    #eye {
        width: 160px;
        height: 160px;
        margin: 0 auto 20px;
        border-radius: 50%;
        background: radial-gradient(circle, #ffffff, #a88bff, #6a40ff);
        box-shadow: 0 0 40px rgba(140, 80, 255, 0.7);
        cursor: pointer;
        transition: 0.25s;
    }

    #eye.active {
        box-shadow: 0 0 60px rgba(0, 255, 140, 1);
    }

    #chat {
        background: #e9eefc;
        padding: 15px;
        border-radius: 15px;
        height: 260px;
        overflow-y: auto;
        text-align: left;
        font-size: 16px;
    }

    .duo { color: #0047ff; margin-bottom: 10px; }
    .you { color: #008a2e; margin-bottom: 10px; }
</style>
</head>

<body>

<div class="container">
    <div id="eye"></div>
    <h1>DUOKID</h1>
    <div id="chat"></div>
    <p>Tap the eye and speak to DuoKid.</p>
</div>

<script>
const eye = document.getElementById("eye");
const chat = document.getElementById("chat");

function addMessage(who, text) {
    const div = document.createElement("div");
    div.className = who;
    div.textContent = (who === "duo" ? "DuoKid: " : "You: ") + text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

// Powitanie
addMessage("duo", "Hi! I'm DuoKid. Tap my eye and talk to me.");

// Rozpoznawanie mowy (Chrome / Edge / Android)
let listening = false;
let recognition = null;

if ("webkitSpeechRecognition" in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = "en-US";
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onstart = () => {
        listening = true;
        eye.classList.add("active");
    };

    recognition.onend = () => {
        listening = false;
        eye.classList.remove("active");
    };

    recognition.onerror = () => {
        addMessage("duo", "Microphone error. Please check permissions.");
        listening = false;
        eye.classList.remove("active");
    };

    recognition.onresult = async (event) => {
        const text = event.results[0][0].transcript;
        addMessage("you", text);
        await askDuokid(text);
    };
} else {
    addMessage("duo", "Your browser does not support voice input.");
}

function speak(text) {
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang = "en-US";
    speechSynthesis.speak(msg);
}

async function askDuokid(text) {
    addMessage("duo", "Thinking...");

    try {
        const res = await fetch("/api/duokid", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text })
        });

        const data = await res.json();
        const reply = data.reply || "I cannot respond right now.";

        addMessage("duo", reply);
        speak(reply);

    } catch (err) {
        addMessage("duo", "Error connecting to server.");
    }
}

eye.addEventListener("click", () => {
    if (!recognition) {
        alert("Speech recognition not supported in this browser.");
        return;
    }
    if (!listening) {
        recognition.start();
    } else {
        recognition.stop();
    }
});
</script>

</body>
</html>
